# LLM API å·¥å…·é›†

è¿™ä¸ªæ–‡ä»¶å¤¹åŒ…å«æ‰€æœ‰ä¸ŽLLM APIäº¤äº’ç›¸å…³çš„å·¥å…·ç¨‹åºã€‚

## ðŸ“ æ–‡ä»¶è¯´æ˜Ž

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜Ž |
|------|------|
| `test_api.py` | APIè¿žæŽ¥æµ‹è¯•å·¥å…· |
| `analyze_episode.py` | EpisodeæŒ‡ä»¤åˆ†æžå™¨ï¼ˆä¸»ç¨‹åºï¼‰ |
| `analyze.sh` | å¿«æ·å¯åŠ¨è„šæœ¬ |
| `api_config.yaml` | APIé…ç½®æ–‡ä»¶ï¼ˆâš ï¸ ä¸ä¼šè¢«gitåŒæ­¥ï¼‰ |
| `README.md` | æœ¬æ–‡æ¡£ |

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®APIå¯†é’¥

**é¦–æ¬¡ä½¿ç”¨**ï¼šå¤åˆ¶æ¨¡æ¿æ–‡ä»¶å¹¶å¡«å…¥ä½ çš„APIå¯†é’¥

```bash
cd llm_api

# å¤åˆ¶æ¨¡æ¿æ–‡ä»¶
cp api_config.yaml.template api_config.yaml

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„APIå¯†é’¥
nano api_config.yaml
```

åœ¨ `api_config.yaml` ä¸­å¡«å…¥ä½ çš„å¯†é’¥ï¼š

```yaml
openrouter:
  api_key: "sk-or-v1-ä½ çš„çœŸå®žå¯†é’¥"
  default_model: "qwen/qwen-2.5-72b-instruct"
  temperature: 0.7
  max_tokens: 1000
  timeout: 30

output:
  output_dir: "analysis_results"
  use_timestamp: true
```

**æ³¨æ„**ï¼š
- âœ… `api_config.yaml.template` ä¼šè¢«æäº¤åˆ° GitHubï¼ˆä¸å«çœŸå®žå¯†é’¥ï¼‰
- âœ… `api_config.yaml` å·²åœ¨ `.gitignore` ä¸­ï¼Œ**ä¸ä¼šè¢«æäº¤**ï¼ˆä¿æŠ¤ä½ çš„å¯†é’¥ï¼‰
- âœ… æ¯ä¸ªäººå…‹éš†ä»“åº“åŽï¼Œä»Žæ¨¡æ¿å¤åˆ¶å¹¶å¡«å…¥è‡ªå·±çš„å¯†é’¥

### 2. æµ‹è¯•APIè¿žæŽ¥

```bash
cd llm_api
python test_api.py
```

### 3. åˆ†æžEpisode

```bash
# éšæœºé€‰æ‹©ä¸€ä¸ªepisodeå¹¶åˆ†æž
bash analyze.sh -a

# æŒ‡å®šepisode IDå¹¶åˆ†æž
bash analyze.sh 1589 -a
```

---

## ðŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜Ž

### `test_api.py` - APIè¿žæŽ¥æµ‹è¯•

**åŠŸèƒ½**ï¼šéªŒè¯OpenRouter APIæ˜¯å¦å¯ä»¥æ­£å¸¸è¿žæŽ¥

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
cd llm_api
python test_api.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
LLM API è¿žæŽ¥æµ‹è¯•
============================================================
æ¨¡åž‹: qwen/qwen-2.5-72b-instruct
API Key: sk-or-v1-6bb0275ad10...62bc

å‘é€æ¶ˆæ¯: ä½ å¥½ï¼Œä½ æ˜¯è°ï¼Ÿ

æ­£åœ¨è¿žæŽ¥API...
============================================================
âœ… è¿žæŽ¥æˆåŠŸï¼
============================================================
LLMå›žå¤: ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œç”±é˜¿é‡Œäº‘å¼€å‘çš„AIåŠ©æ‰‹...
============================================================
```

---

### `analyze_episode.py` - Episodeåˆ†æžå™¨

**åŠŸèƒ½**ï¼šä»ŽVLN-CEæ•°æ®é›†ä¸­æå–episodeçš„å¯¼èˆªæŒ‡ä»¤ï¼Œå¹¶å¯é€‰åœ°ä½¿ç”¨LLMè¿›è¡Œåˆ†æž

**å‘½ä»¤è¡Œå‚æ•°**ï¼š
- `--config`: VLN-CEé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼š`../VLN_CE/vlnce_baselines/config/r2r_baselines/navid_r2r.yaml`ï¼‰
- `--episode-id`: æŒ‡å®šepisode IDï¼ˆä¸æŒ‡å®šåˆ™éšæœºé€‰å–ï¼‰
- `--analyze` æˆ– `-a`: ä½¿ç”¨LLMåˆ†æžæŒ‡ä»¤

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
cd llm_api

# 1. éšæœºé€‰æ‹©ä¸€ä¸ªepisodeï¼ˆä»…æ‰“å°ï¼‰
python analyze_episode.py

# 2. éšæœºé€‰æ‹©å¹¶ä½¿ç”¨LLMåˆ†æž
python analyze_episode.py -a

# 3. æŒ‡å®šepisode ID
python analyze_episode.py --episode-id 1589

# 4. æŒ‡å®šepisodeå¹¶åˆ†æž
python analyze_episode.py --episode-id 1589 -a

# 5. ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶
python analyze_episode.py --config ../VLN_CE/vlnce_baselines/config/rxr_baselines/navid_rxr.yaml -a
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
åŠ è½½æ•°æ®é›†...
2025-10-20 21:00:00,000 Initializing dataset VLN-CE-v1
âœ… éšæœºé€‰æ‹©episode: 1589

================================================================================
Episode ID: 1589
Scene ID: /path/to/scene.glb
Instruction: Walk across the room toward the bedroom. Stop just inside the doorway.
================================================================================

ðŸ¤– LLMåˆ†æžä¸­...

ã€ä»»åŠ¡ç›®æ ‡ã€‘
ä»Žå½“å‰ä½ç½®ç©¿è¿‡æˆ¿é—´ï¼Œå‰å¾€å§å®¤ï¼Œåœ¨è¿›å…¥å§å®¤é—¨å£æ—¶åœä¸‹ã€‚

ã€å…³é”®åœ°æ ‡ã€‘
- æˆ¿é—´ï¼ˆèµ·ç‚¹ï¼‰
- å§å®¤é—¨å£ï¼ˆç»ˆç‚¹ï¼‰

ã€éœ€è¦æ‰§è¡Œçš„åŠ¨ä½œã€‘
1. å‘å‰è¡Œèµ°ç©¿è¿‡å½“å‰æˆ¿é—´
2. è¯†åˆ«å§å®¤å…¥å£ä½ç½®
3. åœ¨åˆšè¿›å…¥å§å®¤é—¨å£æ—¶åœæ­¢
```

---

### `analyze.sh` - å¿«æ·è„šæœ¬

**åŠŸèƒ½**ï¼š`analyze_episode.py` çš„Shellå°è£…ï¼Œæ›´æ–¹ä¾¿ä½¿ç”¨

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
cd llm_api

# æŸ¥çœ‹å¸®åŠ©
bash analyze.sh -h

# éšæœºé€‰æ‹©episode
bash analyze.sh

# éšæœºé€‰æ‹©å¹¶åˆ†æž
bash analyze.sh -a

# æŒ‡å®šepisode
bash analyze.sh 1589

# æŒ‡å®šå¹¶åˆ†æž
bash analyze.sh 1589 -a
```

---

## ðŸ”§ è‡ªå®šä¹‰æç¤ºè¯

åœ¨ `analyze_episode.py` æ–‡ä»¶çš„ç¬¬ 23-36 è¡Œå¯ä»¥ç¼–è¾‘æç¤ºè¯ï¼š

```python
# ============================================================================
# ðŸ”§ åœ¨è¿™é‡Œç¼–è¾‘æç¤ºè¯
# ============================================================================

SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†è§‰è¯­è¨€å¯¼èˆªï¼ˆVLNï¼‰ä»»åŠ¡åˆ†æžä¸“å®¶ã€‚
è¯·æ ¹æ®ç»™å®šçš„å¯¼èˆªæŒ‡ä»¤ï¼Œæä¾›ç®€æ´ä½†ä¸“ä¸šçš„åˆ†æžã€‚"""

USER_PROMPT_TEMPLATE = """è¯·åˆ†æžä»¥ä¸‹å¯¼èˆªæŒ‡ä»¤ï¼š

æŒ‡ä»¤ï¼š{instruction}

è¯·ç®€è¦åˆ†æžï¼š
1. ä»»åŠ¡ç›®æ ‡
2. å…³é”®åœ°æ ‡
3. éœ€è¦æ‰§è¡Œçš„åŠ¨ä½œ
"""

# ============================================================================
```

ä¿®æ”¹åŽç›´æŽ¥è¿è¡Œå³å¯ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°ç¼–è¯‘ã€‚

---

## âš™ï¸ é…ç½®è¯´æ˜Ž

### `api_config.yaml` é…ç½®é¡¹

```yaml
openrouter:
  api_key: "sk-or-v1-..."        # OpenRouter APIå¯†é’¥ï¼ˆå¿…å¡«ï¼‰
  default_model: "qwen/qwen-2.5-72b-instruct"  # æ¨¡åž‹åç§°
  temperature: 0.7                # æ¸©åº¦ï¼š0-1ï¼Œè¶Šé«˜è¶Šéšæœº
  max_tokens: 1000               # æœ€å¤§è¾“å‡ºtokenæ•°
  timeout: 30                    # è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰

output:
  output_dir: "analysis_results" # ç»“æžœä¿å­˜ç›®å½•
  use_timestamp: true            # æ˜¯å¦ä½¿ç”¨æ—¶é—´æˆ³
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ `api_config.yaml` å·²åŠ å…¥ `.gitignore`ï¼Œä¸ä¼šè¢«åŒæ­¥åˆ°è¿œç¨‹ä»“åº“
- åœ¨æœåŠ¡å™¨ä¸Šéœ€è¦æ‰‹åŠ¨åˆ›å»ºæ­¤æ–‡ä»¶
- APIå¯†é’¥ä»Ž https://openrouter.ai/keys èŽ·å–

---

## ðŸ“¦ ä¾èµ–åº“

```bash
# PythonåŒ…
pip install pyyaml requests

# Habitatå’ŒVLN-CEç›¸å…³ä¾èµ–ï¼ˆé¡¹ç›®å·²åŒ…å«ï¼‰
# - habitat-sim
# - habitat-lab
# - VLN_CE
```

---

## ðŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### è·¯å¾„å¤„ç†

æ‰€æœ‰è„šæœ¬éƒ½ä½¿ç”¨**ç›¸å¯¹äºŽè„šæœ¬è‡ªèº«ä½ç½®**çš„è·¯å¾„ï¼Œç¡®ä¿åœ¨ä»»ä½•ç›®å½•è¿è¡Œéƒ½èƒ½æ­£ç¡®å·¥ä½œï¼š

- `api_config.yaml`: ä»Žè„šæœ¬æ‰€åœ¨ç›®å½•ï¼ˆ`llm_api/`ï¼‰è¯»å–
- VLN_CEé…ç½®: ä»Žé¡¹ç›®æ ¹ç›®å½•è¯»å–ï¼ˆ`../VLN_CE/...`ï¼‰

### Pythonè·¯å¾„ç®¡ç†

`analyze_episode.py` è‡ªåŠ¨æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„ï¼š

```python
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)
sys.path.insert(0, project_root)
```

è¿™æ ·å°±èƒ½æ­£ç¡®å¯¼å…¥ `VLN_CE` æ¨¡å—ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæŠ¥ `FileNotFoundError: api_config.yaml`ï¼Ÿ

**A**: éœ€è¦åœ¨ `llm_api/` æ–‡ä»¶å¤¹ä¸­åˆ›å»º `api_config.yaml` æ–‡ä»¶ï¼Œä¸æ˜¯é¡¹ç›®æ ¹ç›®å½•ã€‚

```bash
cd llm_api
# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > api_config.yaml << 'EOF'
openrouter:
  api_key: "ä½ çš„å¯†é’¥"
  default_model: "qwen/qwen-2.5-72b-instruct"
  temperature: 0.7
  max_tokens: 1000
  timeout: 30
EOF
```

### Q2: æœåŠ¡å™¨ä¸Šå¦‚ä½•é…ç½®ï¼Ÿ

**A**: åœ¨æœåŠ¡å™¨ä¸Šä¹Ÿéœ€è¦åœ¨ `llm_api/` ç›®å½•åˆ›å»º `api_config.yaml`ï¼š

```bash
# æ–¹æ³•1ï¼šç›´æŽ¥åˆ›å»º
cd /path/to/NaVid-VLN-CE/llm_api
nano api_config.yaml
# ç²˜è´´é…ç½®å†…å®¹åŽä¿å­˜

# æ–¹æ³•2ï¼šä»Žæœ¬åœ°ä¸Šä¼ 
scp llm_api/api_config.yaml user@server:/path/to/NaVid-VLN-CE/llm_api/
```

### Q3: å¦‚ä½•ä¿®æ”¹æ¨¡åž‹å‚æ•°ï¼Ÿ

**A**: ç¼–è¾‘ `api_config.yaml` æ–‡ä»¶ï¼š

- `temperature`: 0.7ï¼ˆé»˜è®¤ï¼‰â†’ æ›´é«˜æ›´éšæœºï¼Œæ›´ä½Žæ›´ç¡®å®š
- `max_tokens`: 1000ï¼ˆé»˜è®¤ï¼‰â†’ æ ¹æ®éœ€è¦è°ƒæ•´è¾“å‡ºé•¿åº¦

### Q4: æ”¯æŒå“ªäº›æ¨¡åž‹ï¼Ÿ

**A**: æ”¯æŒæ‰€æœ‰OpenRouterä¸Šçš„æ¨¡åž‹ï¼Œä¾‹å¦‚ï¼š
- `qwen/qwen-2.5-72b-instruct`ï¼ˆæŽ¨èï¼Œä¸­è‹±æ–‡åŒè¯­ï¼‰
- `anthropic/claude-3.5-sonnet`
- `openai/gpt-4-turbo`
- æ›´å¤šæ¨¡åž‹è§ï¼šhttps://openrouter.ai/models

ä¿®æ”¹ `api_config.yaml` ä¸­çš„ `default_model` å³å¯åˆ‡æ¢ã€‚

### Q5: APIè°ƒç”¨å¤±è´¥æ€Žä¹ˆåŠžï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®ä¸”æœ‰æ•ˆ
2. OpenRouterè´¦æˆ·æ˜¯å¦æœ‰ä½™é¢
3. ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸
4. å…ˆè¿è¡Œ `python test_api.py` æµ‹è¯•è¿žæŽ¥

---

## ðŸ“‚ æ–‡ä»¶ç»“æž„

```
NaVid-VLN-CE/
â”œâ”€â”€ llm_api/                     # LLM APIå·¥å…·æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ README.md               # æœ¬æ–‡æ¡£
â”‚   â”œâ”€â”€ test_api.py             # APIæµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ analyze_episode.py      # Episodeåˆ†æžå™¨
â”‚   â”œâ”€â”€ analyze.sh              # å¿«æ·è„šæœ¬
â”‚   â””â”€â”€ api_config.yaml         # APIé…ç½®ï¼ˆä¸ä¼šåŒæ­¥åˆ°gitï¼‰
â”œâ”€â”€ VLN_CE/                      # VLN-CEæ¨¡å—
â”‚   â””â”€â”€ vlnce_baselines/config/ # é…ç½®æ–‡ä»¶
â””â”€â”€ .gitignore                   # Gitå¿½ç•¥é…ç½®
```

---

## ðŸ” å®‰å…¨æé†’

- âœ… `api_config.yaml` å·²åŠ å…¥ `.gitignore`ï¼Œä¸ä¼šæ³„éœ²åˆ°GitHub
- âš ï¸ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç APIå¯†é’¥
- âš ï¸ ä¸è¦åˆ†äº«åŒ…å«APIå¯†é’¥çš„é…ç½®æ–‡ä»¶
- âœ… å®šæœŸæ£€æŸ¥OpenRouterä½¿ç”¨é¢åº¦

---

## ðŸ“… æ›´æ–°æ—¥å¿—

- **2025-10-20**: 
  - ä¿®å¤è·¯å¾„å¼•ç”¨é—®é¢˜ï¼Œæ”¯æŒåœ¨ `llm_api/` ç›®å½•å†…è¿è¡Œ
  - æ›´æ–° `.gitignore` é…ç½®
  - å®Œå–„æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜Ž
  - ä¼˜åŒ–é”™è¯¯å¤„ç†

- **2025-10-18**: 
  - åˆ›å»ºLLM APIå·¥å…·é›†
  - å®žçŽ°episodeæŒ‡ä»¤åˆ†æžåŠŸèƒ½
  - æ·»åŠ APIè¿žæŽ¥æµ‹è¯•å·¥å…·
